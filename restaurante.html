<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√Årea do Restaurante - DeliveryLocal</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: #f5f5f5; color: #333; }
        .login-screen { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%); padding: 20px; }
        .login-box { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 450px; width: 100%; }
        .login-logo { text-align: center; margin-bottom: 30px; }
        .login-logo h1 { color: #FF6B35; font-size: 1.8rem; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; }
        .form-group input { width: 100%; padding: 14px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 1rem; }
        .form-group input:focus { outline: none; border-color: #FF6B35; }
        .login-btn { width: 100%; background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%); color: white; border: none; padding: 16px; border-radius: 12px; font-size: 1.1rem; font-weight: 600; cursor: pointer; }
        .login-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(255,107,53,0.4); }
        .back-link { text-align: center; margin-top: 20px; }
        .back-link a { color: #FF6B35; text-decoration: none; }
        .dashboard { display: none; min-height: 100vh; }
        .sidebar { width: 280px; background: #1a1a2e; color: white; position: fixed; height: 100vh; }
        .sidebar-header { padding: 30px; background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%); }
        .sidebar-menu { padding: 20px 0; }
        .menu-item { padding: 15px 30px; cursor: pointer; display: flex; align-items: center; gap: 12px; }
        .menu-item:hover, .menu-item.active { background: rgba(255,107,53,0.2); border-left: 4px solid #FF6B35; }
        .sidebar-footer { padding: 20px 30px; border-top: 1px solid rgba(255,255,255,0.1); }
        .logout-btn { width: 100%; background: rgba(255,255,255,0.1); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; }
        .main-content { margin-left: 280px; padding: 30px; }
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .toggle-switch { position: relative; width: 60px; height: 30px; background: #ccc; border-radius: 30px; cursor: pointer; }
        .toggle-switch.active { background: #4CAF50; }
        .toggle-switch::after { content: ''; position: absolute; width: 26px; height: 26px; background: white; border-radius: 50%; top: 2px; left: 2px; transition: all 0.3s; }
        .toggle-switch.active::after { left: 32px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .stat-card-value { font-size: 2rem; font-weight: 700; }
        .section { background: white; border-radius: 15px; padding: 25px; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .filter-tabs { display: flex; gap: 10px; }
        .filter-tab { padding: 8px 16px; border-radius: 20px; border: none; background: #f0f0f0; cursor: pointer; }
        .filter-tab.active { background: #FF6B35; color: white; }
        .order-card { border: 2px solid #f0f0f0; border-radius: 12px; padding: 20px; margin-bottom: 15px; }
        .order-card.new { border-left: 4px solid #FF6B35; }
        .order-card.preparing { border-left: 4px solid #2196F3; }
        .order-card.ready { border-left: 4px solid #FF9800; }
        .order-header { display: flex; justify-content: space-between; margin-bottom: 15px; }
        .order-status { padding: 6px 14px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; }
        .status-pending { background: #FFF3E0; color: #FF6B35; }
        .status-preparing { background: #E3F2FD; color: #1976D2; }
        .status-ready { background: #FFF3E0; color: #F57C00; }
        .order-items { background: #f9f9f9; padding: 15px; border-radius: 10px; margin: 15px 0; }
        .order-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; }
        .order-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; }
        .order-total { font-size: 1.2rem; font-weight: 700; color: #FF6B35; }
        .action-btn { padding: 10px 20px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; }
        .btn-primary { background: #FF6B35; color: white; }
        .btn-secondary { background: #f0f0f0; color: #333; }
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .menu-item-card { background: white; border: 2px solid #f0f0f0; border-radius: 12px; padding: 20px; }
        .menu-item-card.unavailable { opacity: 0.6; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 20px; max-width: 500px; width: 100%; padding: 30px; }
        .toast { position: fixed; bottom: 30px; right: 30px; background: #333; color: white; padding: 16px 24px; border-radius: 12px; opacity: 0; transition: all 0.3s; z-index: 1001; }
        .toast.show { opacity: 1; }
        @media (max-width: 768px) {
            .sidebar { width: 100%; position: relative; height: auto; }
            .main-content { margin-left: 0; }
        }
    </style>
<base target="_blank">
</head>
<body>
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <div class="login-logo">
                <h1>üçΩÔ∏è √Årea do Restaurante</h1>
                <p>Fa√ßa login para gerenciar seu restaurante</p>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" placeholder="seu@email.com" required>
                </div>
                <div class="form-group">
                    <label>Senha</label>
                    <input type="password" id="loginPassword" placeholder="Sua senha" required>
                </div>
                <button type="submit" class="login-btn" id="loginBtn">Entrar</button>
            </form>
            <div class="back-link">
                <a href="index.html">‚Üê Voltar para o site</a>
            </div>
        </div>
    </div>

    <div class="dashboard" id="dashboard">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2 id="restaurantName">Meu Restaurante</h2>
                <p id="restaurantCategory">Categoria</p>
            </div>
            <nav class="sidebar-menu">
                <div class="menu-item active" onclick="showSection('orders')">üì¶ Pedidos</div>
                <div class="menu-item" onclick="showSection('menu')">üçΩÔ∏è Card√°pio</div>
                <div class="menu-item" onclick="showSection('stats')">üìä Estat√≠sticas</div>
                <div class="menu-item" onclick="showSection('settings')">‚öôÔ∏è Configura√ß√µes</div>
            </nav>
            <div class="sidebar-footer">
                <button class="logout-btn" onclick="logout()">üö™ Sair</button>
            </div>
        </aside>

        <main class="main-content">
            <div class="header-bar">
                <h1 id="pageTitle">Pedidos</h1>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span>Restaurante:</span>
                    <div class="toggle-switch" id="statusToggle" onclick="toggleRestaurantStatus()"></div>
                    <span id="statusText">Fechado</span>
                </div>
            </div>

            <div id="statsSection" style="display: none;">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div style="color: #888; margin-bottom: 10px;">Pedidos Hoje</div>
                        <div class="stat-card-value" id="todayOrders">0</div>
                    </div>
                    <div class="stat-card">
                        <div style="color: #888; margin-bottom: 10px;">Faturamento Hoje</div>
                        <div class="stat-card-value" id="todayRevenue">R$ 0</div>
                    </div>
                    <div class="stat-card">
                        <div style="color: #888; margin-bottom: 10px;">Ticket M√©dio</div>
                        <div class="stat-card-value" id="avgTicket">R$ 0</div>
                    </div>
                </div>
            </div>

            <div id="ordersSection">
                <div class="section">
                    <div class="section-header">
                        <h2>Pedidos Recentes</h2>
                        <div class="filter-tabs">
                            <button class="filter-tab active" onclick="filterOrders('all')">Todos</button>
                            <button class="filter-tab" onclick="filterOrders('pending')">Pendentes</button>
                            <button class="filter-tab" onclick="filterOrders('preparing')">Em preparo</button>
                            <button class="filter-tab" onclick="filterOrders('ready')">Prontos</button>
                        </div>
                    </div>
                    <div id="ordersList"></div>
                </div>
            </div>

            <div id="menuSection" style="display: none;">
                <div class="section">
                    <div class="section-header">
                        <h2>Gerenciar Card√°pio</h2>
                        <button class="action-btn btn-primary" onclick="openMenuModal()">+ Novo Item</button>
                    </div>
                    <div class="menu-grid" id="menuGrid"></div>
                </div>
            </div>

            <div id="settingsSection" style="display: none;">
                <div class="section">
                    <h2>Configura√ß√µes</h2>
                    <form id="settingsForm" style="max-width: 600px; margin-top: 20px;">
                        <div class="form-group">
                            <label>Nome do Restaurante</label>
                            <input type="text" id="settingName" required>
                        </div>
                        <div class="form-group">
                            <label>Telefone</label>
                            <input type="tel" id="settingPhone">
                        </div>
                        <div class="form-group">
                            <label>Taxa de Entrega (R$)</label>
                            <input type="number" id="settingDeliveryFee" step="0.01">
                        </div>
                        <button type="submit" class="action-btn btn-primary">Salvar</button>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <div class="modal" id="menuModal">
        <div class="modal-content">
            <h3 id="menuModalTitle">Novo Item</h3>
            <form id="menuItemForm" style="margin-top: 20px;">
                <input type="hidden" id="menuItemId">
                <div class="form-group">
                    <label>Nome</label>
                    <input type="text" id="itemName" required>
                </div>
                <div class="form-group">
                    <label>Descri√ß√£o</label>
                    <textarea id="itemDescription" rows="2"></textarea>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Pre√ßo (R$)</label>
                        <input type="number" id="itemPrice" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>Categoria</label>
                        <input type="text" id="itemCategory" required>
                    </div>
                </div>
                <div style="margin-bottom: 20px;">
                    <label><input type="checkbox" id="itemAvailable" checked> Dispon√≠vel</label>
                </div>
                <button type="submit" class="action-btn btn-primary" style="width: 100%;">Salvar</button>
            </form>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        const SUPABASE_URL = 'https://xnonawfmgsnwmfhwkttb.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhub25hd2ZtZ3Nud21maHdrdHRiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4NjI1MTgsImV4cCI6MjA4NjQzODUxOH0.TF2fI8FjHM9e7lA_DFi0ktAfrBNHgy5M-1aJlqb-qKk';

        let supabase, currentUser = null, currentRestaurant = null, orders = [], menuItems = [], currentFilter = 'all';

        document.addEventListener('DOMContentLoaded', async () => {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            const savedUser = localStorage.getItem('restaurantUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                await loadRestaurantData();
                showDashboard();
            }
        });

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('loginBtn');
            btn.disabled = true; btn.textContent = 'Entrando...';

            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const { data: admin, error } = await supabase.from('admins').select('*').eq('email', email).single();
                if (error || !admin || admin.password !== password) throw new Error('Email ou senha incorretos');

                currentUser = admin;
                localStorage.setItem('restaurantUser', JSON.stringify(admin));
                await loadRestaurantData();
                showDashboard();
                showToast('Login realizado!');
            } catch (error) {
                showToast(error.message);
            } finally {
                btn.disabled = false; btn.textContent = 'Entrar';
            }
        });

        async function loadRestaurantData() {
            const { data: restaurant } = await supabase.from('restaurants').select('*').eq('id', currentUser.restaurant_id).single();
            currentRestaurant = restaurant;
            document.getElementById('restaurantName').textContent = restaurant.name;
            document.getElementById('restaurantCategory').textContent = restaurant.category || 'Restaurante';
            if (restaurant.is_open) {
                document.getElementById('statusToggle').classList.add('active');
                document.getElementById('statusText').textContent = 'Aberto';
            }
            await loadOrders(); await loadMenu(); await loadStats();
            subscribeToOrders();
        }

        async function loadOrders() {
            const { data } = await supabase.from('orders').select('*').eq('restaurant_id', currentRestaurant.id).order('created_at', { ascending: false });
            orders = data || []; displayOrders();
        }

        function displayOrders() {
            const list = document.getElementById('ordersList');
            let filtered = currentFilter === 'all' ? orders : orders.filter(o => o.status === currentFilter);
            if (filtered.length === 0) { list.innerHTML = '<p style="text-align: center; padding: 40px; color: #888;">Nenhum pedido</p>'; return; }

            list.innerHTML = filtered.map(order => {
                const items = order.items || [];
                const date = new Date(order.created_at).toLocaleString('pt-BR');
                const statusText = { 'pending': 'Novo', 'preparing': 'Em preparo', 'ready': 'Pronto', 'delivering': 'Em entrega', 'delivered': 'Entregue', 'cancelled': 'Cancelado' };
                const actions = {
                    'pending': `<button class="action-btn btn-primary" onclick="updateOrderStatus('${order.id}', 'preparing')">Aceitar</button>`,
                    'preparing': `<button class="action-btn btn-primary" onclick="updateOrderStatus('${order.id}', 'ready')">Pronto</button>`,
                    'ready': `<button class="action-btn btn-primary" onclick="updateOrderStatus('${order.id}', 'delivering')">Saiu</button>`,
                    'delivering': `<button class="action-btn btn-primary" onclick="updateOrderStatus('${order.id}', 'delivered')">Entregue</button>`,
                    'delivered': '<span style="color: #4CAF50;">‚úì Conclu√≠do</span>',
                    'cancelled': '<span style="color: #f44336;">‚úó Cancelado</span>'
                };
                return `
                    <div class="order-card ${order.status}">
                        <div class="order-header">
                            <div>
                                <strong>Pedido #${order.id.slice(-6).toUpperCase()}</strong>
                                <div style="color: #888; font-size: 0.9rem;">${date}</div>
                            </div>
                            <span class="order-status status-${order.status}">${statusText[order.status]}</span>
                        </div>
                        <div><strong>üë§ ${order.customer_name}</strong><br>üìû ${order.customer_phone}</div>
                        <div class="order-items">
                            ${items.map(i => `<div class="order-item"><span>${i.quantity}x ${i.name}</span><span>R$ ${(i.price * i.quantity).toFixed(2)}</span></div>`).join('')}
                        </div>
                        <div class="order-footer">
                            <div class="order-total">Total: R$ ${parseFloat(order.total).toFixed(2)}</div>
                            <div>${actions[order.status] || ''}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function updateOrderStatus(id, status) {
            await supabase.from('orders').update({ status: status, updated_at: new Date().toISOString() }).eq('id', id);
            showToast('Status atualizado!'); await loadOrders();
        }

        function filterOrders(status) { currentFilter = status; document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active')); event.target.classList.add('active'); displayOrders(); }

        async function loadMenu() {
            const { data } = await supabase.from('menu_items').select('*').eq('restaurant_id', currentRestaurant.id).order('category');
            menuItems = data || []; displayMenu();
        }

        function displayMenu() {
            const grid = document.getElementById('menuGrid');
            if (menuItems.length === 0) { grid.innerHTML = '<p style="text-align: center; padding: 40px;">Nenhum item</p>'; return; }
            grid.innerHTML = menuItems.map(item => `
                <div class="menu-item-card ${!item.is_available ? 'unavailable' : ''}">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <strong>${item.name}</strong>
                        <span style="color: #FF6B35; font-weight: 700;">R$ ${parseFloat(item.price).toFixed(2)}</span>
                    </div>
                    <div style="color: #888; font-size: 0.9rem; margin-bottom: 10px;">${item.category}</div>
                    <div style="display: flex; gap: 10px;">
                        <button class="action-btn btn-secondary" onclick="editMenuItem('${item.id}')">Editar</button>
                        <button class="action-btn ${item.is_available ? 'btn-secondary' : 'btn-primary'}" onclick="toggleItem('${item.id}', ${!item.is_available})">${item.is_available ? 'Pausar' : 'Ativar'}</button>
                    </div>
                </div>
            `).join('');
        }

        function openMenuModal(id = null) {
            document.getElementById('menuModal').classList.add('active');
            if (id) {
                const item = menuItems.find(i => i.id === id);
                document.getElementById('menuModalTitle').textContent = 'Editar Item';
                document.getElementById('menuItemId').value = item.id;
                document.getElementById('itemName').value = item.name;
                document.getElementById('itemDescription').value = item.description || '';
                document.getElementById('itemPrice').value = item.price;
                document.getElementById('itemCategory').value = item.category;
                document.getElementById('itemAvailable').checked = item.is_available;
            } else {
                document.getElementById('menuModalTitle').textContent = 'Novo Item';
                document.getElementById('menuItemForm').reset();
                document.getElementById('menuItemId').value = '';
            }
        }

        async function toggleItem(id, available) {
            await supabase.from('menu_items').update({ is_available: available }).eq('id', id);
            showToast(available ? 'Item ativado' : 'Item pausado'); await loadMenu();
        }

        document.getElementById('menuItemForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('menuItemId').value;
            const data = {
                restaurant_id: currentRestaurant.id,
                name: document.getElementById('itemName').value,
                description: document.getElementById('itemDescription').value,
                price: parseFloat(document.getElementById('itemPrice').value),
                category: document.getElementById('itemCategory').value,
                is_available: document.getElementById('itemAvailable').checked,
                created_at: new Date().toISOString()
            };
            if (id) await supabase.from('menu_items').update(data).eq('id', id);
            else await supabase.from('menu_items').insert([data]);
            showToast('Item salvo!');
            document.getElementById('menuModal').classList.remove('active');
            await loadMenu();
        });

        async function loadStats() {
            const today = new Date().toISOString().split('T')[0];
            const todayOrders = orders.filter(o => o.created_at.startsWith(today));
            document.getElementById('todayOrders').textContent = todayOrders.length;
            document.getElementById('todayRevenue').textContent = `R$ ${todayOrders.reduce((s, o) => s + parseFloat(o.total), 0).toFixed(2)}`;
            document.getElementById('avgTicket').textContent = `R$ ${todayOrders.length > 0 ? (todayOrders.reduce((s, o) => s + parseFloat(o.total), 0) / todayOrders.length).toFixed(2) : '0.00'}`;
        }

        async function toggleRestaurantStatus() {
            const newStatus = !currentRestaurant.is_open;
            await supabase.from('restaurants').update({ is_open: newStatus }).eq('id', currentRestaurant.id);
            currentRestaurant.is_open = newStatus;
            const toggle = document.getElementById('statusToggle');
            const text = document.getElementById('statusText');
            if (newStatus) { toggle.classList.add('active'); text.textContent = 'Aberto'; showToast('Restaurante aberto!'); }
            else { toggle.classList.remove('active'); text.textContent = 'Fechado'; showToast('Restaurante fechado'); }
        }

        function showSection(section) {
            ['orders', 'menu', 'stats', 'settings'].forEach(s => document.getElementById(s + 'Section').style.display = 'none');
            document.getElementById(section + 'Section').style.display = 'block';
            document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
            event.target.classList.add('active');
            const titles = { 'orders': 'Pedidos', 'menu': 'Card√°pio', 'stats': 'Estat√≠sticas', 'settings': 'Configura√ß√µes' };
            document.getElementById('pageTitle').textContent = titles[section];
        }

        function showDashboard() { document.getElementById('loginScreen').style.display = 'none'; document.getElementById('dashboard').style.display = 'block'; }
        function logout() { localStorage.removeItem('restaurantUser'); location.reload(); }
        function showToast(msg) { const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000); }
        function subscribeToOrders() { supabase.channel('orders').on('postgres_changes', { event: '*', schema: 'public', table: 'orders', filter: `restaurant_id=eq.${currentRestaurant.id}` }, () => { loadOrders(); showToast('Novo pedido!'); }).subscribe(); }
    </script>
</body>
</html>